# R-Type CI Workflow

name: CI

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*.*.*'
    paths-ignore:
      - "**/*.md"
      - "docs/**"
  pull_request:
    branches: [ "*" ]
  workflow_dispatch:

env:
  MIRROR_REPO_URL: "git@github.com:EpitechPGE3-2025/G-CPP-500-NAN-5-2-rtype-8.git"

jobs:
  # -----------------------------
  # Detect Changes
  # -----------------------------
  check-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      server: ${{ steps.filter.outputs.server }}
      client: ${{ steps.filter.outputs.client }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Filter paths
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            server:
              - 'server/**'
            client:
              - 'client/**'
            ci:
              - '.github/workflows/**'
              - 'scripts/**'
              - 'Dockerfile'
              - '.clang-format'
              - '.clang-tidy'

  # -----------------------------
  # Quick Check Repository
  # -----------------------------
  check-repository:
    runs-on: ubuntu-latest
    outputs:
      same_repository: ${{ steps.check_repo.outputs.same_repository }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Is this the mirror repository?
        id: check_repo
        run: |
          if [ "${{ github.event.repository.ssh_url }}" = "${{ env.MIRROR_REPO_URL }}" ]; then
            echo "::warning::Repository is the same as the mirror repository."
            echo "same_repository=true" >> $GITHUB_OUTPUT
          else
            echo "::notice::Repository is different from the mirror repository."
            echo "same_repository=false" >> $GITHUB_OUTPUT
          fi

  # -----------------------------
  # Linter
  # -----------------------------
  linter:
    name: Linter
    runs-on: ubuntu-latest
    needs: [check-changes]
    if: >
      startsWith(github.ref, 'refs/tags/v') ||
      github.event_name == 'workflow_dispatch' ||
      (needs.check-changes.result != 'failure' && (
        needs.check-changes.outputs.ci == 'true' ||
        needs.check-changes.outputs.server == 'true' ||
        needs.check-changes.outputs.client == 'true'
      ))

    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-20

      - name: Run linter
        run: |
          echo "Running linter..."
          if [ -f ./scripts/lint-check.sh ]; then
            chmod +x ./scripts/lint-check.sh && ./scripts/lint-check.sh
          else
            echo "ERROR: No linter script found."
            exit 1
          fi

  # -----------------------------
  # Build and Test (server - Linux)
  # Produces artifacts: r-type_server-Linux
  # -----------------------------
  build-server-linux:
    name: Build Server & Tests (Linux)
    runs-on: ubuntu-latest
    needs: check-changes
    if: >
      startsWith(github.ref, 'refs/tags/v') ||
      github.event_name == 'workflow_dispatch' ||
      (needs.check-changes.result != 'failure' && needs.check-changes.outputs.server == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential ninja-build curl zip unzip tar \
            libx11-dev libxi-dev libxrandr-dev libxcursor-dev \
            libudev-dev libgl1-mesa-dev libglu1-mesa-dev git

      - name: Restore vcpkg cache
        uses: actions/cache@v3
        with:
          path: |
            vcpkg
            vcpkg_installed
            build/_deps/vcpkg-*
          key: vcpkg-linux-sfml3-gtest

      - name: Setup vcpkg
        run: |
          if [ ! -d vcpkg ]; then
            git clone https://github.com/microsoft/vcpkg.git
            ./vcpkg/bootstrap-vcpkg.sh
          fi

      - name: Configure CMake (server)
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=${PWD}/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DBUILD_TESTING=ON -DBUILD_SERVER_ONLY=ON

      - name: Build server and tests
        run: cmake --build build -j$(nproc)

      - name: Run server tests
        run: ctest --test-dir build -V

      - name: Prepare server artifact
        run: |
          echo "Searching for r-type_server in build..."
          BIN="$(find . -type f -name 'r-type_server' -executable | head -n 1)"
          if [ -z "$BIN" ]; then
            echo "ERROR: r-type_server not found. Listing executables in build:"
            find build -type f -executable -maxdepth 6 -print
            exit 1
          fi
          mkdir -p dist
          cp "$BIN" dist/r-type_server-linux

      - name: Upload Server Artifact (if exists)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: r-type_server-Linux
          path: dist/r-type_server-linux
          if-no-files-found: ignore

  # -----------------------------
  # Build and Test (server - Windows)
  # Produces artifacts: r-type_server-Windows
  # -----------------------------
  build-server-windows:
    name: Build Server & Tests (Windows)
    runs-on: windows-latest
    needs: check-changes
    if: >
      startsWith(github.ref, 'refs/tags/v') ||
      github.event_name == 'workflow_dispatch' ||
      (needs.check-changes.result != 'failure' && needs.check-changes.outputs.server == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Restore vcpkg cache
        uses: actions/cache@v3
        with:
          path: |
            vcpkg
            vcpkg_installed
            build/_deps/vcpkg-*
          key: vcpkg-windows-sfml3-gtest

      - name: Setup vcpkg
        run: |
          if (!(Test-Path vcpkg)) {
            git clone https://github.com/microsoft/vcpkg.git
            .\vcpkg\bootstrap-vcpkg.bat
          }

      - name: Configure CMake (server)
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}\vcpkg\scripts\buildsystems\vcpkg.cmake `
            -DBUILD_TESTING=ON `
            -DBUILD_SERVER_ONLY=ON

      - name: Build server and tests
        run: cmake --build build --config Release

      - name: Run server tests
        run: ctest --test-dir build -C Release -V

      - name: Locate server binary
        id: find_server
        shell: pwsh
        run: |
          Write-Host "Searching for r-type_server executable in workspace..."

          $exe = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter *.exe |
                 Where-Object { $_.Name -match "^r-type_server.*\.exe$" } |
                 Select-Object -First 1

          if (-not $exe) {
            Write-Error "r-type_server executable not found in workspace"
            exit 1
          }

          New-Item -ItemType Directory -Force -Path "dist" | Out-Null
          Copy-Item $exe.FullName "dist\r-type_server-windows.exe" -Force

      - name: Upload Server Artifact (if exists)
        uses: actions/upload-artifact@v4
        with:
          name: r-type_server-Windows
          path: dist/r-type_server-windows.exe
          if-no-files-found: ignore

  # -----------------------------
  # Build and Test (client - Linux)
  # Produces artifacts: client/r-type_client-Linux
  # -----------------------------
  build-client-linux:
    name: Build & Test client
    runs-on: ubuntu-latest
    needs: check-changes
    if: >
      startsWith(github.ref, 'refs/tags/v') ||
      github.event_name == 'workflow_dispatch' ||
      (needs.check-changes.result != 'failure' && needs.check-changes.outputs.client == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential ninja-build curl zip unzip tar \
            libx11-dev libxi-dev libxrandr-dev libxcursor-dev \
            libudev-dev libgl1-mesa-dev libglu1-mesa-dev git

      - name: Restore vcpkg cache
        uses: actions/cache@v3
        with:
          path: |
            vcpkg
            vcpkg_installed
            build/_deps/vcpkg-*
          key: vcpkg-linux-sfml3-gtest

      - name: Setup vcpkg
        run: |
          if [ ! -d vcpkg ]; then
            git clone https://github.com/microsoft/vcpkg.git
            ./vcpkg/bootstrap-vcpkg.sh
          fi

      - name: Configure CMake (client)
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=${PWD}/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DBUILD_TESTING=ON -DBUILD_CLIENT_ONLY=ON

      - name: Build client and tests
        run: cmake --build build -j$(nproc)

      - name: Run client tests
        run: ctest --test-dir build -V

      - name: Prepare client artifact
        run: |
          echo "Searching for r-type_client in build..."
          BIN="$(find . -type f -name 'r-type_client' -executable | head -n 1)"
          if [ -z "$BIN" ]; then
            echo "ERROR: r-type_client not found. Listing executables in build:"
            find build -type f -executable -maxdepth 6 -print
            exit 1
          fi
          mkdir -p dist
          cp "$BIN" dist/r-type_client-linux

      - name: Upload Client Artifact (if exists)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: r-type_client-Linux
          path: dist/r-type_client-linux
          if-no-files-found: ignore

  # -----------------------------
  # Build and Test (client - Windows)
  # Produces artifacts: client/r-type_client-Windows
  # -----------------------------
  build-client-windows:
    name: Build & Test client (Windows)
    runs-on: windows-latest
    needs: check-changes
    if: >
      startsWith(github.ref, 'refs/tags/v') ||
      github.event_name == 'workflow_dispatch' ||
      (needs.check-changes.result != 'failure' && needs.check-changes.outputs.client == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Restore vcpkg cache
        uses: actions/cache@v3
        with:
          path: |
            vcpkg
            vcpkg_installed
            build/_deps/vcpkg-*
          key: vcpkg-windows-sfml3-gtest

      - name: Setup vcpkg
        run: |
          if (!(Test-Path vcpkg)) {
            git clone https://github.com/microsoft/vcpkg.git
            .\vcpkg\bootstrap-vcpkg.bat
          }

      - name: Configure CMake (client)
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}\vcpkg\scripts\buildsystems\vcpkg.cmake `
            -DBUILD_TESTING=ON -DBUILD_CLIENT_ONLY=ON

      - name: Build client and tests
        run: cmake --build build --config Release

      - name: Run client tests
        run: ctest --test-dir build -C Release -V

      - name: Prepare client artifact
        shell: pwsh
        run: |
          Write-Host "Searching for r-type_client in workspace..."
          $exe = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter *.exe |
                 Where-Object { $_.Name -match "^r-type_client.*\.exe$" } |
                 Select-Object -First 1

          if (-not $exe) {
            Write-Error "ERROR: r-type_client not found."
            exit 1
          }

          New-Item -ItemType Directory -Force -Path "dist" | Out-Null
          Copy-Item $exe.FullName "dist\r-type_client-windows.exe" -Force

      - name: Upload Client Artifact (if exists)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: r-type_client-Windows
          path: dist/r-type_client-windows.exe
          if-no-files-found: ignore


  # -----------------------------
  # Semantic Release
  # -----------------------------
  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    needs: [check-repository, linter, build-server-linux, build-server-windows, build-client-linux, build-client-windows]
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.check-repository.outputs.same_repository == 'false' &&
      needs.linter.result == 'success' &&
      (
        needs.build-server-linux.result == 'success' ||
        needs.build-server-windows.result == 'success' ||
        needs.build-client-linux.result == 'success' || 
        needs.build-client-windows.result == 'success'
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install semantic-release
        run: npm install -g semantic-release @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/github
      - name: Run semantic-release
        run: semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}

  # -----------------------------
  # Upload Binaries to Release
  # -----------------------------
  upload-release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs:
      - build-server-linux
      - build-server-windows
      - build-client-linux
      - build-client-windows
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download Server Artifact (Linux)
        uses: actions/download-artifact@v4
        with:
          name: r-type_server-Linux
          path: ./artifacts/

      - name: Download Server Artifact (Windows)
        uses: actions/download-artifact@v4
        with:
          name: r-type_server-Windows
          path: ./artifacts/

      - name: Download Client Artifact (Linux)
        uses: actions/download-artifact@v4
        with:
          name: r-type_client-Linux
          path: ./artifacts/

      - name: Check downloaded artifacts
        run: |
          echo "Checking downloaded artifacts..."
          find ./artifacts/ -type f
          test -f ./artifacts/dist/r-type_server-linux
          test -f ./artifacts/dist/r-type_server-windows.exe
          test -f ./artifacts/dist/r-type_client-linux

      - name: Upload binaries to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/dist/r-type_server-linux
            ./artifacts/dist/r-type_server-windows.exe
            ./artifacts/dist/r-type_client-linux
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # -----------------------------
  # Push to Mirror Repository
  # -----------------------------
  push-to-mirror:
    name: Push to Mirror Repository
    runs-on: ubuntu-latest
    needs: [check-repository, linter, build-server-linux, build-server-windows, build-client-linux, build-client-windows, semantic-release, upload-release-assets]
    if: |
      always() &&
      github.event_name == 'push' &&
      needs.check-repository.outputs.same_repository == 'false' &&
      needs.linter.result == 'success' &&
      (
        needs.semantic-release.result == 'success' ||
        needs.semantic-release.result == 'skipped'
      ) &&
      (
        needs.upload-release-assets.result == 'success' ||
        needs.upload-release-assets.result == 'skipped'
      ) &&
      (
        needs.build-server-linux.result == 'success' ||
        needs.build-server-linux.result == 'skipped'
      ) &&
      (
        needs.build-server-windows.result == 'success' ||
        needs.build-server-windows.result == 'skipped'
      ) &&
      (
        needs.build-client-linux.result == 'success' ||
        needs.build-client-linux.result == 'skipped'
      ) &&
      (
        needs.build-client-windows.result == 'success' ||
        needs.build-client-windows.result == 'skipped'
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: pixta-dev/repository-mirroring-action@v1
        with:
          target_repo_url: ${{ env.MIRROR_REPO_URL }}
          ssh_private_key: ${{ secrets.R_TYPE_SSH_KEY }}
