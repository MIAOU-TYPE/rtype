name: CI

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*.*.*'
    paths-ignore:
      - "**/*.md"
      - "docs/**"
  pull_request:
    branches: [ "*" ]
  workflow_dispatch:

env:
  MIRROR_REPO_URL: "git@github.com:EpitechPGE3-2025/G-CPP-500-NAN-5-2-rtype-8.git"

# =============================
# Detect Changes
# =============================
jobs:
  check-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      server: ${{ steps.filter.outputs.server }}
      client: ${{ steps.filter.outputs.client }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            server:
              - 'server/**'
            client:
              - 'client/**'
            ci:
              - '.github/workflows/**'
              - 'scripts/**'
              - '.clang-format'
              - '.clang-tidy'

  # =============================
  # Linter
  # =============================
  linter:
    name: Linter
    runs-on: ubuntu-latest
    needs: [check-changes]
    if: >
      startsWith(github.ref, 'refs/tags/v') ||
      github.event_name == 'workflow_dispatch' ||
      (needs.check-changes.result != 'failure' && (
        needs.check-changes.outputs.ci == 'true' ||
        needs.check-changes.outputs.server == 'true' ||
        needs.check-changes.outputs.client == 'true'
      ))

    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-20

      - name: Run linter
        run: |
          echo "Running linter..."
          if [ -f ./scripts/lint-check.sh ]; then
            chmod +x ./scripts/lint-check.sh && ./scripts/lint-check.sh
          else
            echo "ERROR: No linter script found."
            exit 1
          fi

  # =============================
  # Server Linux
  # =============================
  build-server-linux:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.server == 'true'
    steps:
      - uses: actions/checkout@v4
      - run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ninja-build git
      - uses: actions/cache@v3
        with:
          path: |
            vcpkg
            vcpkg_installed
            build/_deps
          key: vcpkg-linux
      - run: |
          [ -d vcpkg ] || git clone https://github.com/microsoft/vcpkg.git
          ./vcpkg/bootstrap-vcpkg.sh
          cmake -S . -B build -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=$PWD/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DBUILD_SERVER_ONLY=ON -DBUILD_TESTING=ON
          cmake --build build
          ctest --test-dir build --output-on-failure
      - uses: actions/upload-artifact@v4
        with:
          name: r-type_server-linux
          path: build/**/r-type_server

  # =============================
  # Server Windows
  # =============================
  build-server-windows:
    runs-on: windows-latest
    needs: check-changes
    if: needs.check-changes.outputs.server == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: ilammy/msvc-dev-cmd@v1
      - run: choco install ninja -y
      - uses: actions/cache@v3
        with:
          path: |
            vcpkg
            vcpkg_installed
            build/_deps
          key: vcpkg-windows
      - shell: pwsh
        run: |
          if (!(Test-Path vcpkg)) { git clone https://github.com/microsoft/vcpkg.git }
          .\vcpkg\bootstrap-vcpkg.bat
          $toolchain="$env:GITHUB_WORKSPACE\vcpkg\scripts\buildsystems\vcpkg.cmake"
          cmake -S . -B build -G Ninja `
            -DCMAKE_TOOLCHAIN_FILE="$toolchain" `
            -DBUILD_SERVER_ONLY=ON -DBUILD_TESTING=ON
          cmake --build build
          ctest --test-dir build --output-on-failure
      - uses: actions/upload-artifact@v4
        with:
          name: r-type_server-windows
          path: build/**/r-type_server.exe

  # =============================
  # Client Linux
  # =============================
  build-client-linux:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.client == 'true'
    steps:
      - uses: actions/checkout@v4
      - run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ninja-build git
      - uses: actions/cache@v3
        with:
          path: |
            vcpkg
            vcpkg_installed
            build/_deps
          key: vcpkg-linux
      - run: |
          [ -d vcpkg ] || git clone https://github.com/microsoft/vcpkg.git
          ./vcpkg/bootstrap-vcpkg.sh
          cmake -S . -B build -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=$PWD/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DBUILD_CLIENT_ONLY=ON -DBUILD_TESTING=ON
          cmake --build build
          ctest --test-dir build --output-on-failure
      - uses: actions/upload-artifact@v4
        with:
          name: r-type_client-linux
          path: build/**/r-type_client

  # =============================
  # Client Windows
  # =============================
  build-client-windows:
    runs-on: windows-latest
    needs: check-changes
    if: needs.check-changes.outputs.client == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: ilammy/msvc-dev-cmd@v1
      - run: choco install ninja -y
      - uses: actions/cache@v3
        with:
          path: |
            vcpkg
            vcpkg_installed
            build/_deps
          key: vcpkg-windows
      - shell: pwsh
        run: |
          if (!(Test-Path vcpkg)) { git clone https://github.com/microsoft/vcpkg.git }
          .\vcpkg\bootstrap-vcpkg.bat
          $toolchain="$env:GITHUB_WORKSPACE\vcpkg\scripts\buildsystems\vcpkg.cmake"
          cmake -S . -B build -G Ninja `
            -DCMAKE_TOOLCHAIN_FILE="$toolchain" `
            -DBUILD_CLIENT_ONLY=ON -DBUILD_TESTING=ON
          cmake --build build
          ctest --test-dir build --output-on-failure
      - uses: actions/upload-artifact@v4
        with:
          name: r-type_client-windows
          path: build/**/r-type_client.exe

  # =============================
  # Upload Release Assets
  # =============================
  upload-release-assets:
    runs-on: ubuntu-latest
    needs:
      - build-server-linux
      - build-server-windows
      - build-client-linux
      - build-client-windows
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - run: |
          echo "Artifacts:"
          find artifacts -type f
      - uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**
